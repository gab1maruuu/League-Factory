version: "3.8" 

services:
  # 1. Servidor Web (Tu aplicación PHP)
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile 
    container_name: mvc_app 
    ports:
      - "8080:80" 
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html 
      # Variables para los Webhooks que usarás más adelante 
      - N8N_WEBHOOK_POST_CREATED=http://n8n:5678/webhook/post-published
      - N8N_WEBHOOK_COMMENT_CREATED=http://n8n:5678/webhook/comment-created
      - N8N_WEBHOOK_COMMENT_DELETED=http://n8n:5678/webhook/comment-deleted
      - N8N_SHARED_TOKEN=mi_token_secreto
    volumes:
      - ./:/var/www/html # Sincroniza tu código local con el contenedor
    depends_on:
      - db 
    networks:
      - mvc_net 

  # 2. Base de Datos MySQL
  db:
    image: mysql:8.0 
    container_name: mvc_db 
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=root 
      - MYSQL_DATABASE=blog_db 
      - MYSQL_USER=blog_user 
      - MYSQL_PASSWORD=blog_pass 
    ports:
      - "3306:3306" 
    volumes:
      - db_data:/var/lib/mysql 
      # Carga automática del script SQL al iniciar por primera vez
      - ./database.sql:/docker-entrypoint-initdb.d/01-database.sql:ro 
    networks:
      - mvc_net 

  # 3. Automatización n8n
  n8n:
    image: n8nio/n8n 
    container_name: mvc_n8n 
    restart: unless-stopped
    ports:
      - "5678:5678" 
    environment:
      - GENERIC_TIMEZONE=Europe/Madrid 
      - N8N_BASIC_AUTH_ACTIVE=true 
      - N8N_BASIC_AUTH_USER=admin 
      - N8N_BASIC_AUTH_PASSWORD=admin123 
    volumes:
      - n8n_data:/home/node/.n8n 
    networks:
      - mvc_net 

  # 4. phpMyAdmin (Gestión visual de DB)
  phpmyadmin:
    image: phpmyadmin/phpmyadmin 
    container_name: mvc_phpmyadmin 
    restart: unless-stopped
    environment:
      - PMA_HOST=db 
      - PMA_USER=blog_user 
      - PMA_PASSWORD=blog_pass 
    ports:
      - "8081:80" 
    depends_on:
      - db 
    networks:
      - mvc_net 

# Definición de volúmenes y redes
volumes:
  db_data: 
  n8n_data: 

networks:
  mvc_net:
    driver: bridge